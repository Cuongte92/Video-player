<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Frame Player + WebDAV</title>
<style>
  :root{--frame:#000;--ui:#0f0f0f;--fg:#fff;--muted:#b9b9b9;--prog:#e53935;--buf:#5b5b5b;--chip:#1a1a1a;--chip-sel:#2d5aff}
  *{box-sizing:border-box} body{margin:0;background:#f4f4f4;min-height:100vh;display:grid;place-items:center;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .frame{width:min(1000px,96vw);aspect-ratio:16/9;position:relative;background:#000;box-shadow:0 0 0 14px var(--frame)}
  video{width:100%;height:100%;display:block;background:#000;object-fit:contain}
  video::-webkit-media-controls{display:none !important}

  /* bottom controls */
  .bar{position:absolute;left:0;right:0;bottom:0;background:var(--ui);color:var(--fg);
       display:flex;align-items:center;gap:12px;padding:8px 10px;opacity:0;transition:.2s}
  .frame.show-ui .bar{opacity:1}
  .btn{appearance:none;border:0;background:transparent;color:#fff;font-size:18px;cursor:pointer}
  .time{min-width:78px;color:var(--muted)}
  .track{position:relative;height:6px;flex:1;border-radius:999px;background:#1a1a1a;overflow:hidden}
  .buf,.prog{position:absolute;left:0;top:0;bottom:0;width:0%}.buf{background:var(--buf)}.prog{background:var(--prog)}
  #seek{position:absolute;inset:0;opacity:0}

  /* icon dock */
  .dock{position:absolute;right:10px;top:10px;display:flex;gap:8px;opacity:0;transition:.2s;z-index:5}
  .frame.show-ui .dock{opacity:1}
  .icon{width:36px;height:36px;border:2px solid #000;border-radius:8px;background:#fff;display:grid;place-items:center;cursor:pointer;font-weight:900}

  /* popovers */
  .pop{position:absolute;background:#111e;backdrop-filter:blur(4px);color:#fff;border:2px solid #000;border-radius:8px;
       padding:10px;z-index:6;display:none;max-width:min(46%,420px)}
  .pop.show{display:block}

  #popQ{right:10px;top:56px}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{border:0;border-radius:999px;padding:6px 10px;background:var(--chip);color:#fff;cursor:pointer}
  .chip.sel{background:var(--chip-sel)}

  #popS{right:10px;top:56px;transform:translateY(58px)}
  #popS input{width:100%;padding:6px 8px;border:0;border-radius:6px;margin-top:6px;color:#111}
  .btn2{border:0;border-radius:6px;padding:6px 10px;background:#000;color:#fff;cursor:pointer}

  #popU{left:10px;bottom:56px;max-width:min(70%,680px)}
  #popU .row{display:flex;gap:6px}
  #popU input{flex:1;padding:8px 10px;border-radius:6px;border:0}
  #popU .go{border:0;background:#000;color:#fff;border-radius:6px;padding:8px 12px;font-weight:700}

  #popF{right:10px;bottom:56px}
  #popF label{display:block;border:0;background:#000;color:#fff;border-radius:6px;padding:8px 12px;cursor:pointer}
  #file{display:none}

  /* WEBdav pop */
  #popD{right:10px;top:56px;transform:translateY(116px);min-width:min(46vw,420px)}
  #popD input{width:100%;padding:8px;border-radius:6px;border:0;margin:6px 0;color:#111}
  #davList{max-height:42vh;overflow:auto;border:1px solid #0003;border-radius:8px;padding:6px}
  .row-file{padding:8px;border-radius:6px;background:#1a1a1a;margin:4px 0;word-break:break-all;cursor:pointer}
  .row-file:hover{background:#222}

</style>
</head>
<body>
<div class="frame" id="frame">
  <video id="v" playsinline preload="metadata" x-webkit-airplay="allow" airplay="allow" crossorigin="anonymous"></video>

  <!-- icon dock -->
  <div class="dock">
    <div class="icon" id="btnQ">HD</div>
    <div class="icon" id="btnS">CC</div>
    <div class="icon" id="btnU">‚Üó</div>
    <div class="icon" id="btnF">üìÅ</div>
    <div class="icon" id="btnD">DAV</div>
  </div>

  <!-- Quality -->
  <div class="pop" id="popQ">
    <div style="font-weight:700;margin-bottom:6px">Quality</div>
    <div class="chips" id="qlist"><button class="chip sel" id="qAuto" style="display:none">Auto</button></div>
  </div>

  <!-- Subtitles -->
  <div class="pop" id="popS">
    <div style="font-weight:700;margin-bottom:6px">Subtitles (.srt)</div>
    <div class="chips" style="margin-bottom:6px">
      <button class="btn2" id="subUrlBtn">Add URL</button>
      <label class="btn2" for="subFile">Add File</label>
      <input id="subFile" type="file" accept=".srt">
      <button class="btn2" id="subClear">Remove</button>
    </div>
    <input id="subUrl" type="text" placeholder="D√°n URL .srt r·ªìi Enter">
  </div>

  <!-- Open URL -->
  <div class="pop" id="popU">
    <div style="font-weight:700;margin-bottom:6px">Open URL</div>
    <div class="row">
      <input id="url" type="text" placeholder="D√°n link video (mp4, mov, ts, m3u8‚Ä¶)">
      <button class="go" id="go">‚û°Ô∏è</button>
    </div>
  </div>

  <!-- Local file -->
  <div class="pop" id="popF">
    <div style="font-weight:700;margin-bottom:6px">Local file</div>
    <label for="file">Choose file‚Ä¶</label>
    <input id="file" type="file" accept="video/*,.ts">
  </div>

  <!-- WebDAV -->
  <div class="pop" id="popD">
    <div style="font-weight:700;margin-bottom:6px">WebDAV</div>
    <input id="davServer" type="text" placeholder="Server (vd: https://example.com/remote.php/dav/files/USER/)">
    <input id="davPath"   type="text" placeholder="Path (vd: / ho·∫∑c /Movies/)">
    <input id="davUser"   type="text" placeholder="Username">
    <input id="davPass"   type="password" placeholder="Password">
    <div class="chips" style="margin:6px 0">
      <button class="btn2" id="davBrowse">Browse</button>
      <button class="btn2" id="davUp">Up</button>
    </div>
    <div id="davList"></div>
    <div style="opacity:.7;margin-top:6px;font-size:12px">G·ª£i √Ω: n·∫øu server public, ƒë·ªÉ tr·ªëng user/pass. V·ªõi Basic Auth, tr√¨nh duy·ªát c√≥ th·ªÉ y√™u c·∫ßu t·∫£i file th√†nh blob tr∆∞·ªõc khi ph√°t.</div>
  </div>

  <!-- bottom bar -->
  <div class="bar">
    <button class="btn" id="pp">‚ñ∂</button>
    <span class="time" id="cur">00:00</span>
    <div class="track"><div class="buf" id="buf"></div><div class="prog" id="prog"></div><input type="range" id="seek" min="0" max="1000" value="0"></div>
    <span class="time" id="dur">00:00</span>
    <button class="btn" id="pip">‚ßâ</button>
    <button class="btn" id="fs">‚õ∂</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
/* ===== core helpers ===== */
const $=s=>document.querySelector(s);
const frame=$('#frame'), v=$('#v');
const pp=$('#pp'), cur=$('#cur'), dur=$('#dur'), seek=$('#seek'), prog=$('#prog'), buf=$('#buf');
const pip=$('#pip'), fs=$('#fs');

const btnQ=$('#btnQ'), btnS=$('#btnS'), btnU=$('#btnU'), btnF=$('#btnF'), btnD=$('#btnD');
const popQ=$('#popQ'), popS=$('#popS'), popU=$('#popU'), popF=$('#popF'), popD=$('#popD');
const qlist=$('#qlist'), qAuto=$('#qAuto');
const urlIn=$('#url'), go=$('#go'), fileIn=$('#file');
const subUrl=$('#subUrl'), subUrlBtn=$('#subUrlBtn'), subFile=$('#subFile'), subClear=$('#subClear');

let hls=null, hideTimer=null;
const isHls=u=>/\.m3u8(\?|$)/i.test(u);
const fmt=t=>{t=Math.max(0,Math.floor(t||0));const h=Math.floor(t/3600),m=Math.floor((t%3600)/60),s=t%60;return(h?(h+':'):'')+String(m).padStart(2,h?'0':'')+':'+String(s).padStart(2,'0')}
function destroyHls(){if(hls){try{hls.destroy()}catch{} hls=null} qlist.innerHTML=''; qAuto.style.display='none'}
function showUI(){frame.classList.add('show-ui'); clearTimeout(hideTimer); hideTimer=setTimeout(()=>frame.classList.remove('show-ui'),3500)}
frame.addEventListener('pointerdown',showUI);
function openOnly(el){[popQ,popS,popU,popF,popD].forEach(p=>p.classList.toggle('show',p===el)); showUI()}
btnQ.onclick=()=>openOnly(popQ);
btnS.onclick=()=>openOnly(popS);
btnU.onclick=()=>openOnly(popU);
btnF.onclick=()=>openOnly(popF);
btnD.onclick=()=>openOnly(popD);

/* ===== play by URL (mp4 / m3u8 ‚Ä¶) ===== */
async function playURL(u){
  if(!u) return; destroyHls();
  if(isHls(u) && !v.canPlayType('application/vnd.apple.mpegurl')){
    if(window.Hls && Hls.isSupported()){
      hls=new Hls({enableWorker:true,maxBufferLength:60});
      hls.loadSource(u); hls.attachMedia(v);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
        const lvls=(hls.levels||[]).slice().sort((a,b)=>(b.height||0)-(a.height||0));
        qlist.innerHTML='';
        if(lvls.length){
          qAuto.style.display='inline-block'; qAuto.onclick=()=>{hls.currentLevel=-1;mark(qAuto)}; qlist.appendChild(qAuto); mark(qAuto);
          lvls.forEach((L,idx)=>{const b=document.createElement('button'); b.className='chip'; const h=L.height||0; b.textContent=h?`${h}p`:(L.name||('L'+idx));
            b.onclick=()=>{hls.currentLevel=L.id ?? idx; mark(b)}; qlist.appendChild(b);});
        }
        v.play().catch(()=>{});
      });
    } else alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ HLS.');
  } else { v.src=u; v.play().catch(()=>{}); }
  openOnly(null);
}
function mark(btn){qlist.querySelectorAll('.chip').forEach(x=>x.classList.remove('sel')); btn.classList.add('sel')}
go.onclick=()=>playURL(urlIn.value.trim());
urlIn.addEventListener('keydown',e=>{if(e.key==='Enter') go.click()});
fileIn.addEventListener('change',()=>{const f=fileIn.files[0]; if(!f) return; destroyHls(); v.src=URL.createObjectURL(f); v.play().catch(()=>{}); openOnly(null); fileIn.value=''});

/* ===== subtitles (SRT -> VTT) ===== */
function srtToVtt(srt){const lines=srt.replace(/\r+/g,'').trim().split('\n');let out=['WEBVTT',''];let i=0;while(i<lines.length){const line=lines[i].trim();if(/^\d+$/.test(line)){i++;continue}const m=line.match(/^(\d{2}:\d{2}:\d{2}[,\.]\d{1,3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,\.]\d{1,3})(.*)$/);if(m){const s=m[1].replace(',', '.'),e=m[2].replace(',', '.'),rest=(m[3]||'');out.push(`${s} --> ${e}${rest}`);i++;while(i<lines.length && lines[i].trim()!==''){out.push(lines[i]);i++}out.push('')}else i++}return out.join('\n')}
function addSubtitleFromText(text,label='Subtitle'){v.querySelectorAll('track[data-auto="1"]').forEach(t=>t.remove());const src=URL.createObjectURL(new Blob([srtToVtt(text)],{type:'text/vtt'}));const tr=document.createElement('track');tr.kind='subtitles';tr.label=label;tr.srclang='xx';tr.src=src;tr.default=true;tr.dataset.auto='1';v.appendChild(tr)}
subUrl.addEventListener('keydown',async e=>{if(e.key==='Enter'){const u=subUrl.value.trim(); if(!u) return; try{const r=await fetch(u); const txt=await r.text(); addSubtitleFromText(txt,(u.split('/').pop()||'Subtitle')); subUrl.value=''; openOnly(null);}catch(err){alert('Kh√¥ng t·∫£i ph·ª• ƒë·ªÅ: '+err)}}});
subFile.addEventListener('change',()=>{const f=subFile.files[0]; if(!f) return; const rd=new FileReader(); rd.onload=()=>{addSubtitleFromText(String(rd.result), f.name); openOnly(null)}; rd.readAsText(f); subFile.value='';});
subClear.onclick=()=>{v.querySelectorAll('track[data-auto="1"]').forEach(t=>t.remove()); openOnly(null)};

/* ===== baseline UI events ===== */
function update(){const d=v.duration||0,c=v.currentTime||0; cur.textContent=fmt(c); dur.textContent=d?fmt(d):'00:00'; prog.style.width=(d?(c/d*100):0)+'%'; if(!seek.dragging) seek.value=Math.round((c/(d||1))*1000); try{if(v.buffered.length){const e=v.buffered.end(v.buffered.length-1); buf.style.width=(d?(e/d*100):0)+'%'}}catch{}}
v.addEventListener('timeupdate',update); v.addEventListener('progress',update); v.addEventListener('loadedmetadata',update);
pp.onclick=()=>v.paused? v.play(): v.pause(); v.addEventListener('click',()=>v.paused? v.play(): v.pause());
v.addEventListener('play',()=>{pp.textContent='‚ùö‚ùö'}); v.addEventListener('pause',()=>{pp.textContent='‚ñ∂'});
seek.addEventListener('input',()=>{seek.dragging=true; const d=v.duration||0; v.currentTime=(seek.value/1000)*d}); seek.addEventListener('change',()=>seek.dragging=false);
fs.onclick=()=>{const el=v; if(document.fullscreenElement) document.exitFullscreen(); else (el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el)};
pip.onclick=async()=>{try{ if(document.pictureInPictureElement) await document.exitPictureInPicture(); else if(v.requestPictureInPicture) await v.requestPictureInPicture(); }catch(e){alert('PiP kh√¥ng kh·∫£ d·ª•ng: '+e)}};

/* ===== WebDAV ===== */
const davServer=$('#davServer'), davUser=$('#davUser'), davPass=$('#davPass'), davPath=$('#davPath');
const davListEl=$('#davList'), davBrowse=$('#davBrowse'), davUp=$('#davUp');

function joinURL(base, path){
  if(!base) return '';
  if(!path) return base;
  if(!base.endsWith('/')) base+='/';
  path = path.replace(/^\/+/,'');
  return base + path;
}
function toAuthURL(u, user, pass){
  try{
    const x = new URL(u);
    if(user){ x.username = user; x.password = pass||''; }
    return x.toString();
  }catch{ return u; }
}
function buildAuthHeader(){
  const u=davUser.value.trim(), p=davPass.value;
  return (u ? {'Authorization':'Basic '+btoa(u+':'+(p||''))} : {});
}
async function davList(dir){
  const base = davServer.value.trim();
  if(!base){ alert('Nh·∫≠p WebDAV server tr∆∞·ªõc'); return; }
  if(dir!=null) davPath.value = dir;
  const url = joinURL(base, davPath.value || '/');
  davListEl.innerHTML = 'ƒêang t·∫£i...';

  try{
    const res = await fetch(url, {
      method:'PROPFIND',
      headers: {
        ...buildAuthHeader(),
        'Depth':'1'
      }
    });
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    const xml = new DOMParser().parseFromString(await res.text(),'text/xml');
    const items = [...xml.getElementsByTagName('response')].map(r=>{
      const href = r.getElementsByTagName('href')[0]?.textContent || '';
      const type = r.getElementsByTagName('getcontenttype')[0]?.textContent || '';
      const len  = r.getElementsByTagName('getcontentlength')[0]?.textContent || '';
      return {href, type, len};
    }).filter(x=>x.href && !x.href.endsWith('/.well-known/'));

    // Normalize and render
    const baseURL = new URL(url);
    const curPath = baseURL.pathname.endsWith('/')? baseURL.pathname : baseURL.pathname+'/';
    davListEl.innerHTML='';
    items.forEach(it=>{
      let path = decodeURIComponent(new URL(it.href, baseURL).pathname);
      if(path === curPath) return; // skip self
      const isDir = path.endsWith('/');
      const name = path.slice(path.lastIndexOf('/', path.endsWith('/')?path.length-2:path.length-1)+1).replace(/\/$/,'');
      const row = document.createElement('div'); row.className='row-file';
      row.textContent = (isDir?'üìÅ ':'') + name + (isDir?'':'  ' + (it.len?`(${(+it.len/1048576).toFixed(1)} MB)`:''));
      row.onclick = ()=> isDir ? davList(joinURL(davPath.value||'/', name+'/')) : davPlay(path);
      davListEl.appendChild(row);
    });
  }catch(e){
    davListEl.textContent = 'L·ªói duy·ªát WebDAV: '+e.message;
  }
}
async function davPlay(pathname){
  const base = davServer.value.trim();
  const fileURL = joinURL(base, pathname);
  const user = davUser.value.trim(), pass = davPass.value;

  // n·∫øu public / cho ph√©p user:pass@host ‚Üí ph√°t tr·ª±c ti·∫øp
  let direct = toAuthURL(fileURL, user, pass);
  if (isHls(direct)) { playURL(direct); return; }

  try{
    // Th·ª≠ ph√°t tr·ª±c ti·∫øp tr∆∞·ªõc (ƒë·ªëi v·ªõi mp4/webm‚Ä¶ server public)
    v.src = direct; await v.play(); openOnly(null); return;
  }catch{}

  // Fallback: t·∫£i blob r·ªìi ph√°t (s·∫Ω ƒë·ª£i t·∫£i xong)
  try{
    const res = await fetch(fileURL, { headers: { ...buildAuthHeader() }});
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    const blob = await res.blob();
    v.src = URL.createObjectURL(blob);
    await v.play(); openOnly(null);
  }catch(e){
    alert('Kh√¥ng th·ªÉ ph√°t file t·ª´ WebDAV: '+e.message);
  }
}

davBrowse.onclick=()=>davList();
davUp.onclick=()=>{
  let p = (davPath.value || '/').replace(/\/+$/,'/');
  if (p === '/' ) return;
  p = p.slice(0, p.lastIndexOf('/', p.endsWith('/')?p.length-2:p.length-1)+1) || '/';
  davList(p);
};

/* ===== autoload by ?src= ===== */
(function autoload(){
  const u=new URLSearchParams(location.search).get('src'); if(u){ urlIn.value=u; playURL(u); }
})();
</script>
</body>
</html>
